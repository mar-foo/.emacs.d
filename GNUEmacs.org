#+TITLE: Emacs configuration
#+STARTUP: overview
#+AUTHOR: Mario Forzanini
#+HTML_HEAD: <link rel="stylesheet" href="style/simple.css">
* Look and Feel
** Icons
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (use-package all-the-icons)
  (use-package emojify
    :defer t
    :commands (emojify-mode)
    :hook
    (elfeed-mode-hook . emojify-mode)
    (eww-mode-hook . emojify-mode))
#+end_src
** Line numbers
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
      (column-number-mode)
      (global-display-line-numbers-mode t)
      (menu-bar--display-line-numbers-mode-relative)

      (dolist (mode '(term-mode-hook
                      completion-list-mode-hook
                      eshell-mode-hook
                      vterm-mode-hook
                      helpful-mode-hook
                      elfeed-search-mode
                      elfeed-show-mode))
        (add-hook mode (lambda () (display-line-numbers-mode 0))))
#+end_src
** Elisp parentheses
Use [[https://github.com/Fanael/rainbow-delimiters][rainbow-delimiters]] for nice parentheses coloring
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (use-package rainbow-delimiters
    :defer t
    :commands rainbow-delimiters-mode
    :hook
    (org-mode . rainbow-delimiters-mode)
    (prog-mode . rainbow-delimiters-mode))
#+end_src
** Layout
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (setq display-buffer-alist '(("\\*vterm\\*"  (display-buffer-below-selected)
                                (window-height . 0.4))
                               ("\\*Packages\\*" (display-buffer-below-selected)
                                (window-height . 0.4))
                               ("\\*WoMan" (display-buffer-below-selected)
                                (window-height . 0.4))
                               ("\\*[Hh]elp" (display-buffer-below-selected)
                                (window-height . 0.4))))
#+end_src
* Keybindings
** Evil mode
#+BEGIN_SRC emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (use-package evil
    :init
    (setq evil-want-integration t
          evil-want-keybinding nil
          evil-undo-system 'undo-redo
          evil-vsplit-window-right t
          evil-split-window-below t
          evil-disable-insert-state-bindings t)
    :config
    (evil-mode 1))
#+END_SRC
** Leader key definitions
*** Helper functions
#+begin_src emacs-lisp  :tangle ~/.emacs.d/GNUEmacs.el
  (defun mf/reload-configuration ()
    "Reloads configuration"
    (interactive)
    (load-file (concat user-emacs-directory "init.el")))

  (defun mf/edit-configuration ()
    "Edit emacs configuration"
    (interactive)
    (find-file "~/.emacs.d/GNUEmacs.org"))

  (defun mf/find-recentf ()
    "Open a recent file"
    (interactive)
    (find-file (completing-read "Recent File: " recentf-list nil t)))

  (defun mf/toggle-vterm (&optional use-generic-p)
    "Toggle vterm window respecting buffer-alist configuration.
    If there is a prefix argument, switch to the vterm buffer."
    (interactive "P")
    (if (get-buffer-window "*vterm*")
        (delete-window (get-buffer-window "*vterm*"))
      (if use-generic-p
          (switch-to-buffer "*vterm*")
        (vterm))))
#+end_src
*** Leader key
Use [[https://github.com/noctuid/general.el][general]] to setup space bar as leader key in normal mode, C-SPC in
other modes.
#+begin_src emacs-lisp  :tangle ~/.emacs.d/GNUEmacs.el
  (use-package general
    :init
    (general-override-mode 1)
    :config
    (general-evil-setup t)

    (general-create-definer mf/leader-keys
      :keymaps '(normal insert visual emacs)
      :prefix "SPC"
      :global-prefix "C-SPC")
#+end_src
**** General definitions
Commonly used bindings for different purposes; Prefix: C-c
| Keybinding | Action              |
|------------+---------------------|
| SPC-b      | Buffers prefix      |
| SPC-f      | Files prefix        |
| SPC-h      | Help prefix         |
| SPC-i      | Insert prefix       |
| SPC-m      | Major mode prefix   |
| SPC-O      | Org prefix          |
| SPC-q      | Quit prefix         |
| SPC-q-q    | Exit Emacs          |
| SPC-w      | Window prefix       |
| SPC-/      | Music prefix        |
| SPC-SPC    | M-x                 |
#+begin_src emacs-lisp  :tangle ~/.emacs.d/GNUEmacs.el
  (mf/leader-keys
    "a" '(:ignore t :which-key "Applications")
    "b" '(:ignore t :which-key "Buffers")
    "c" '(:ignore t :which-key "Code")
    "f" '(:ignore t :which-key "Files")
    "g" '(:ignore t :which-key "Git")
    "H" '(:ignore t :which-key "Help")
    "i" '(:ignore t :which-key "Insert")
    "j" '(:ignore t :which-key "Jump")
    "q" '(:ignore t :which-key "Quit")
    "t" '(:ignore t :which-key "Toggle")
    "w" '(:ignore t :which-key "Windows")
    "O" '(:ignore t :which-key "Org")

    "SPC" '(execute-extended-command :which-key "M-x")
    "qq" '(save-buffers-kill-terminal :which-key "Exit Emacs")
    "o" '(delete-other-windows :which-key "Only!")
#+end_src
**** Buffer management
Quick bookmarks; Prefix: C-c-b
| Keybinding | Action        |
|------------+---------------|
| SPC-b-d    | Delete buffer |
| SPC-b-r    | Rename buffer |
#+begin_src emacs-lisp  :tangle ~/.emacs.d/GNUEmacs.el
  "b"  '(switch-to-buffer :which-key "Switch to buffer")
  "C-b" '(list-buffers :which-key "Ibuffer")
  "d"  '(kill-current-buffer :which-key "Delete buffer")
#+end_src
**** Code
#+BEGIN_SRC emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
"cc" '(compile :which-key "Compile")
"ce" '(eval-buffer :which-key "Eval buffer")
"cr" '(recompile :which-key "Recompile")
"cE" '(eval-region :which-key "Eval region")
"c(" '(check-parens :which-key "Check parens")
#+END_SRC
**** File management
Movement in the filesystem; Prefix: C-c-f
| Keybinding | Action                   |
|------------+--------------------------|
| SPC-f-s    | Save buffer              |
| SPC-f-e    | Emacs prefix             |
| SPC-f-e-d  | Edit emacs configuration |
| SPC-f-e-R  | Reload emacs configuration |
#+begin_src emacs-lisp  :tangle ~/.emacs.d/GNUEmacs.el
  "fd" '(dired :which-key "Dired")
  "ff" '(find-file :which-key "Find-file")
  "fe" '(:ignore t :which-key "Emacs")
  "fed" '(mf/edit-configuration :which-key "Emacs configuration")
  "feR" '(mf/reload-configuration :which-key "Reload configuration")
  "fr" '(mf/find-recentf :which-key "Recent files")
  "fs" '(save-buffer :which-key "Save buffer")
#+end_src
**** Help
| Keybindings | Action                |
|-------------+-----------------------|
| SPC-H-a     | Apropos               |
| SPC-H-c     | Key briefly           |
| SPC-H-d     | Apropos documentation |
| SPC-H-e     | Emacs                 |
| SPC-H-i     | Info                  |
| SPC-H-k     | Key                   |
| SPC-H-l     | Lossage               |
| SPC-H-m     | Mode                  |
| SPC-H-n     | Emacs news            |
| SPC-H-q     | Quit                  |
| SPC-H-r     | Info emacs            |
| SPC-H-s     | Syntax                |
| SPC-H-C     | Coding system         |
| SPC-H-F     | Info command          |
| SPC-H-I     | Input method          |
| SPC-H-K     | Info key              |
| SPC-H-L     | Language environment  |
| SPC-H-P     | Package               |
| SPC-H-S     | Symbol                |
| SPC-H-?     | Help                  |
#+BEGIN_SRC emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
"Ha" '(apropos-command :which-key "Apropos")
"Hb" '(describe-bindings :which-key "Bindings")
"Hc" '(describe-key-briefly :which-key "Key briefly")
"Hd" '(apropos-documentation :which-key "Apropos documentation")
"He" '(about-emacs :which-key "Emacs")
"Hf" '(describe-function :which-key "Function")
"Hi" '(info :which-key "Info")
"Hk" '(describe-key :which-key "Key")
"Hl" '(view-lossage :which-key "Lossage")
"Hm" '(describe-mode :which-key "Mode")
"Hn" '(view-emacs-news :which-key "Emacs news")
"Hq" '(help-quit :which-key "Quit")
"Hr" '(info-emacs-manual :which-key "Info emacs")
"Hs" '(describe-syntax :which-key "Syntax")
"Hv" '(describe-variable :which-hey "Variable")
"HC" '(describe-coding-system :which-key "Coding system")
"HF" '(Info-goto-emacs-command-node :which-key "Info command")
"HI" '(describe-input-method :which-key "Input method")
"HK" '(Info-goto-emacs-key-command-node :which-key "Info key")
"HL" '(describe-language-environment :which-key "Language environment")
"HP" '(describe-package :which-key "Package")
"HS" '(info-lookup-symbol :which-key "Info symbol")
"H?" '(help-for-help :which-key "Help")
#+END_SRC
**** Toggle
#+BEGIN_SRC emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  "tr" '(read-only-mode :which-key "Read only mode")
  "tw" '(visual-line-mode :which-key "Soft line wrapping")
;; Define functions to toggle auto-completion, smartparens, yasnippet...
#+END_SRC
**** Windows
    Manage windows; Prefix: SPC-w
| Keybinding | Action           |
|------------+------------------|
| SPC-h      | Focus left       |
| SPC-l      | Focus right      |
| SPC-j      | Focus down       |
| SPC-k      | Focus up         |
| SPC-w-c    | Close            |
| SPC-w-q    | Close            |
| SPC-w-v    | Vertical split   |
| SPC-w-s    | Horizontal split |
| SPC-w-m    | Maximize         |
| SPC-w-=    | Balance windows  |
| SPC-w-w    | Other-window     |
#+BEGIN_SRC emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  "h" '(windmove-left :which-key "Focus left")
  "l" '(windmove-right :which-key "Focus-right")
  "j" '(windmove-down :which-key "Focus Down")
  "k" '(windmove-up :which-key "Focus Up")
  "wc" '(delete-window :which-key "Close")
  "wq" '(delete-window :which-key "Close")
  "wv" '(split-window-right :which-key "Vertical-split")
  "ws" '(split-window-below :which-key "Horizontal split")
  "wm" '(maximize-window :which-key "Maximize")
  "w=" '(balance-windows :which-key "Balance windows")
  "ww" '(other-window :which-key "Other window")
  ))
#+END_SRC
** Hydra
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (use-package hydra
    :defer t
    :commands hydra-resize/body)
#+end_src
*** Window resizing
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
      (defun mf/window-enlarge ()
        (interactive)
        (shrink-window -6 t))
      (defun mf/window-shrink ()
        (interactive)
        (shrink-window 6 t))
      (defun mf/window-taller ()
        (interactive)
        (shrink-window -6 nil))
      (defun mf/window-shorter ()
        (interactive)
        (shrink-window 6 nil))
      (defun mf/window-big-enlarge ()
        (interactive)
        (shrink-window -12 t))
      (defun mf/window-big-shrink ()
        (interactive)
        (shrink-window 12 t))
      (defun mf/window-big-taller ()
        (interactive)
        (shrink-window -12 nil))
      (defun mf/window-big-shorter ()
        (interactive)
        (shrink-window 12 nil))

      (defhydra hydra-resize (global-map "C-c r")
        "resize"
        ("h" mf/window-shrink)
        ("l" mf/window-enlarge)
        ("j" mf/window-taller)
        ("k" mf/window-shorter)
        ("H" mf/window-big-shrink)
        ("L" mf/window-big-enlarge)
        ("J" mf/window-big-taller)
        ("K" mf/window-big-shorter)
        ("n" windmove-down)
        ("p" windmove-up)
        ("b" windmove-left)
        ("f" windmove-right)
        ("0" delete-window)
        ("2" split-window-below)
        ("3" split-window-right)
        ("q" nil))
#+end_src
*** Buffer cycling
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (defhydra hydra-buf-cycle (global-map "C-c b b")
    "cycle"
    ("d" kill-current-buffer)
    ("j" scroll-up-command)
    ("k" scroll-down-command)
    ("n" bs-cycle-next)
    ("p" bs-cycle-previous)
    ("q" nil))
#+end_src
** Evil integrations
Use [[https://github.com/emacs-evil/evil][evil]] keybindings to make my life better, [[https://github.com/emacs-evil/evil-collection][evil-collection]] to use
vim keybindings in many modes and [[https://github.com/syl20nbr/evil-escape][evil-escape]] to map 'jk' to escape
in insert mode
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el 
  (use-package evil-collection
    :after evil
    :config
    (evil-collection-init)
    (setq evil-want-C-i-jump t))
  (use-package evil-escape
    :after evil
    :config
    (evil-escape-mode)
    (setq evil-escape-key-sequence "jk"))
#+end_src
* Completion framework
** Prescient
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (use-package prescient
    :defer t
    :hook (minibuffer-inactive-mode-hook . prescient-persistent-mode))
#+end_src
** Make use of the Emacs default minibuffer
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (use-package marginalia
    :init
    (marginalia-mode))

  (use-package orderless
    :config
    (defun my-orderless-initialism-dispatcher (pattern _index _total)
      "Leading initialism dispatcher using the comma suffix.
                                   It matches PATTERN _INDEX and _TOTAL according to how Orderless parses it input."
      (when (string-suffix-p "," pattern)
        `(orderless-strict-leading-initialism . ,(substring pattern 0 -1))))
    (defun my-orderless-literal-dispatcher (pattern _index _total)
      "Literal style dispatcher using the equal sign as a suffix.
                                   It matches PATTERN _INDEX and _TOTAL according to how Orderless parses it input."
      (when (string-suffix-p "=" pattern )
        `(orderless-literal . ,(substring pattern 0 -1))))
    (defun my-orderless-flex-dispatcher (pattern _index _total)
      "Flex dispatcher using the tilde suffix.
                     It matches PATTERN _INDEX and _TOTAL according to how Orderless
                     parses its input."
      (when (string-suffix-p "~" pattern)
        `(orderless-flex . ,(substring pattern 0 -1))))
    (setq my-orderless-default-styles
          '(orderless-strict-leading-initialism
            orderless-flex
            orderless-prefixes
            orderless-regexp)
          orderless-component-separator "[ &]"      ; Completion at point using & as a separator, SPC automatically exits completion
          orderless-matching-styles my-orderless-default-styles
          orderless-style-dispatchers
          '(my-orderless-literal-dispatcher
            my-orderless-initialism-dispatcher
            my-orderless-flex-dispatcher)
          completion-styles '(orderless))
    (let ((map minibuffer-local-completion-map))
      ;; SPC should never complete, use it for orderless groups'
      (define-key map (kbd "SPC") nil)
      (define-key map (kbd "?") nil)))
#+end_src
From [[https://www.protesilaos.com][protesilaos]] config
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (defun prot-minibuffer-focus-minibuffer ()
    "Focus the active minibuffer."
    (interactive)
    (let ((mini (active-minibuffer-window)))
      (when mini
        (select-window mini))))

  (defun prot-minibuffer--fit-completions-window ()
    "Fit Completions' buffer to its window."
    (fit-window-to-buffer (get-buffer-window "*Completions*")
                          (floor (frame-height) 2) 1))

  (defun prot-common-number-negative ( n )
    "Make N negative."
    (if (and (numberp n) (> n 0))
        (* -1 n)
      (error "%s is not a valid positive number" n)))


  (defun prot-minibuffer--switch-to-completions ()
    "Subroutine for switching to the completions' buffer."
    (unless (get-buffer-window "*Completions*" 0)
      (minibuffer-completion-help))
    (switch-to-completions)
    (prot-minibuffer--fit-completions-window))

  (defun prot-minibuffer-switch-to-completions-top ()
    "Switch to the top of the completions' buffer.
                    Meant to be bound in `minibuffer-local-completion-map'."
    (interactive)
    (prot-minibuffer--switch-to-completions)
    (goto-char (point-min))
    (next-completion 1))

  (defun prot-minibuffer-switch-to-completions-bottom ()
    "Switch to the bottom of the completions' buffer.
                    Meant to be bound in `minibuffer-local-completion-map'."
    (interactive)
    (prot-minibuffer--switch-to-completions)
    (goto-char (point-max))
    (next-completion -1)
    (goto-char (point-at-bol))
    (recenter
     (- -1
        (min (max 0 scroll-margin)
             (truncate (/ (window-body-height) 4.0))))
     t))

  (defun prot-minibuffer-next-completion-or-mini (&optional arg)
    "Move to the next completion or switch to the minibuffer.
                    This performs a regular motion for optional ARG lines, but when
                    point can no longer move in that direction it switches to the
                    minibuffer."
    (interactive "p")
    (cond
     ((and (bobp)   ; see hack in `prot-minibuffer--clean-completions'
           (get-text-property (point) 'invisible))
      (forward-char 1)
      (next-completion (or arg 1)))
     ((or (eobp)
          (eq (point-max)
              (save-excursion (forward-line 1) (point))))
      (prot-minibuffer-focus-minibuffer))
     (t
      (next-completion (or arg 1))))
    (setq this-command 'next-line))

  (defun prot-minibuffer-previous-completion-or-mini (&optional arg)
    "Move to the next completion or switch to the minibuffer.
                    This performs a regular motion for optional ARG lines, but when
                    point can no longer move in that direction it switches to the
                    minibuffer."
    (interactive "p")
    (let ((num (prot-common-number-negative arg)))
      (if (or (bobp)
              (eq (point) (1+ (point-min)))) ; see hack in `prot-minibuffer--clean-completions'
          (prot-minibuffer-focus-minibuffer)
        (next-completion (or num 1)))))
  ;; Copied from icomplete.el
  (defun prot-minibuffer--field-beg ()
    "Determine beginning of completion."
    (if (window-minibuffer-p)
        (minibuffer-prompt-end)
      (nth 0 completion-in-region--data)))
  (defun prot-minibuffer--completion-category ()
    "Return completion category."
    (let* ((beg (prot-minibuffer--field-beg))
           (md (completion--field-metadata beg)))
      (alist-get 'category (cdr md))))
  (defun prot-minibuffer-backward-updir ()
    "Delete char before point or go up a directory.
    Must be bound to `minibuffer-local-filename-completion-map'."
    (interactive)
    (if (and (eq (char-before) ?/)
             (eq (prot-minibuffer--completion-category) 'file))
        (save-excursion
          (goto-char (1- (point)))
          (when (search-backward "/" (point-min) t)
            (delete-region (1+ (point)) (point-max))))
      (call-interactively 'backward-delete-char)))
#+end_src
** Minibuffer completions
Adjust completions buffer size (and all temp buffers)
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (setq temp-buffer-max-height 10)
  (temp-buffer-resize-mode)
#+end_src
Override completion style for buffer and file name completions
(~/.em/el/ expands to ~/.emacs.d/elpa no matter what text there is
befor the ~)
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (file-name-shadow-mode 1)
  (setq completion-styles '(orderless partial-completion))
  (setq completion-category-overrides
        '((buffer (styles . (substring flex orderless)))
          (file (styles . (partial-completion orderless)))))
#+end_src
Set important variables
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (setq completion-cycle-threshold nil)
  (setq completion-flex-nospace nil)
  (setq completion-pcm-complete-word-inserts-delimiters t)
  (setq completion-show-help nil)
  (setq completion-auto-help t)
  (setq completion-ignore-case t)
  (setq-default case-fold-search t)
  (setq read-buffer-completion-ignore-case t)
  (setq read-file-name-completion-ignore-case t)
  (setq completions-format 'vertical)
  (setq completions-detailed t)
  (setq resize-mini-windows nil)
  (setq minibuffer-eldef-shorten-default t)
  (setq echo-keystrokes 0.25)
  (file-name-shadow-mode 1)
  (minibuffer-electric-default-mode 1)
#+end_src
Keybindings
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (let ((map completion-list-mode-map))
    (define-key map (kbd "C-n") #'prot-minibuffer-next-completion-or-mini)
    (define-key map (kbd "C-p") #'prot-minibuffer-previous-completion-or-mini))
  (let ((map minibuffer-local-completion-map))
    (define-key map (kbd "C-n") #'prot-minibuffer-switch-to-completions-top)
    (define-key map (kbd "C-p") #'prot-minibuffer-switch-to-completions-bottom)
    (define-key map (kbd "RET") #'minibuffer-force-complete-and-exit))
  (let ((map minibuffer-local-filename-completion-map))
    (define-key map (kbd "<M-backspace>") #'prot-minibuffer-backward-updir))
#+end_src
** Corfu
Use corfu for better completions at point
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (use-package corfu
    :config (corfu-global-mode))
#+end_src
* Helpful
Use [[https://github.com/Wilfred/helpful][helpful]] to get better help, highlighting and references to the
source files
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (use-package page-break-lines
    :defer t
    :commands page-break-lines-mode)

  (use-package helpful
    :defer t
    :commands (helpful-callable helpful-variable helpful-command helpful-key)
    :hook
    (helpful-mode . page-break-lines-mode)
    (helpful-mode . visual-line-mode)
    :bind
    ([remap describe-variable] . helpful-variable)
    ([remap describe-command] . helpful-command)
    ([remap describe-key] . helpful-key)
    (:map helpful-mode-map
          ("q" . mf/quit-and-kill)					; Quitting help buffer kills them too
          ("n" . next-line)
          ("p" . previous-line))
    :config
    (defun mf/quit-and-kill ()
      (interactive)
      (quit-window t)))
#+end_src
* Programming
** Autocompletion
Get [[http://company-mode.github.io/][autocompletion]]. Edit: try to use Emacs' built in completion-at-point
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (setq tab-always-indent 'complete)
  (autoload 'ffap-file-at-point "ffap")
  (defun complete-path-at-point+ ()
    "Return completion data for UNIX path at point."
    (let ((fn (ffap-file-at-point))
          (fap (thing-at-point 'filename)))
      (when (and (or fn (equal "/" fap))
                 (save-excursion
                   (search-backward fap (line-beginning-position) t)))
        (list (match-beginning 0)
              (match-end 0)
              #'completion-file-name-table :exclusive 'no))))

  (add-hook 'completion-at-point-functions
            #'complete-path-at-point+
            'append)
#+end_src
** Projectile
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (use-package projectile
    :defer t
    :commands projectile-mode
    :hook
    (c-mode . projectile-mode)
    (c++-mode . projectile-mode)
    (haskell-mode . projectile-mode)
    (emacs-lisp-mode . projectile-mode))
#+end_src
** Go
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (use-package go-mode
    :defer t
    :commands go-mode)
#+end_src
** Haskell
#+begin_src emacs-lisp
  (use-package hindent
    :defer t
    :hook (haskell-mode-hook . hindent-mode)
    :config (setq hindent-reformat-buffer-on-save t))

  (use-package haskell-mode
    :defer t
    :commands haskell-mode
    :hook (haskell-mode-hook . interactive-haskell-mode)
    (haskell-mode-hook . haskell-indentation-mode))

  ;; (use-package dante
  ;;   :after haskell-mode
  ;;   :commands 'dante-mode
  ;;   :init
  ;;   (add-hook 'haskell-mode-hook 'interactive-haskell-mode)
  ;;   (add-hook 'haskell-mode-hook 'haskell-indentation-mode)
  ;;   (add-hook 'haskell-mode-hook 'flycheck-mode)
  ;;   (add-hook 'haskell-mode-hook 'dante-mode))
#+end_src
** Smart parentheses
#+BEGIN_SRC emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (use-package smartparens
    :defer t
    :commands smartparens-mode
    :hook
    ((prog-mode . smartparens-mode)
    (emacs-lisp-mode . smartparens-mode)
    (org-mode . smartparens-mode)
    (scheme-mode . smartparens-mode))
    :config
    (require 'smartparens-config))
#+END_SRC
** Git
Use magit to handle git repositories
#+BEGIN_SRC emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
      (use-package magit
    :defer t
  :commands magit
  :general (mf/leader-keys
            "gb" '(magit-branch-checkout :which-key "Switch branch")
            "gc" '(:ignore t :which-key "Create")
            "gcb" '(magit-branch-and-checkout :which-key "Branch")
            "gcc" '(magit-commit-create :which-key "Commit")
            "gcr" '(magit-init :which-key "Initialize repository")
            "gcR" '(magit-clone :which-key "Clone")
            "gf" '(:ignore t :which-key "Find")
            "gfc" '(magit-show-commit :which-key "Commit")
            "gfg" '(magit-find-git-config-file :which-key "Gitconfig file")
            "gg" '(magit-status :which-key "Status")
            "gt" '(git-timemachine-toggle :which-key "Timemachine")
            "gB" '(magit-blame-addition :which-key "Blame")
            "gC" '(magit-clone :which-key "Clone")
            "gD" '(magit-file-delete :which-key "Delete file")
            "gF" '(magit-fetch :which-key "Fetch")
            "gG" '(magit-status-here :which-key "Status here")
            "gL" '(magit-log :which-key "Log")
            "gS" '(magit-stage-file :which-key "Stage file")
            "gU" '(magit-unstage-file :which-key "Unstage file")))
#+END_SRC
* Shell
*** eshell
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (defun mf/configure-eshell ()
    (add-hook 'eshell-pre-command-hook 'eshell-save-some-history)
    (add-to-list 'eshell-output-filter-functions 'eshell-truncate-buffer))

  (use-package eshell-git-prompt
    :defer t
    :after eshell)
  (use-package eshell
    :defer t
    :commands eshell
    :hook (eshell-first-time-mode . mf/configure-eshell)
    :config
    (setq eshell-history-size 5000
          eshell-buffer-maximum-lines 5000
          eshell-hist-ignoredups t
          eshell-scroll-to-bottom-on-input t)
    (with-eval-after-load 'esh-opt
      (setq eshell-destroy-buffer-when-process-dies t)
      (setq eshell-visual-commands '("htop" "sh"))
      (eshell-git-prompt-use-theme 'powerline)))
#+end_src
*** vterm
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
      (use-package vterm
        :defer t
        :commands vterm
        :config
        (setq vterm-shell "/bin/sh")
        :general (mf/leader-keys
                   "RET" '(mf/toggle-vterm :which-key "vterm")))
#+end_src
* Org mode
** Setup
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
    (defun mf/org-mode-setup ()
          (org-indent-mode)
          (visual-line-mode 1))
#+end_src
** Org
#+begin_src emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
  (use-package org
    :defer t
    :hook (org-mode . mf/org-mode-setup)
    :general (mf/leader-keys
               "Ot" '(:ignore t :which-key "Tangle")
               "Ott" '(org-babe-tangle :which-key "Tangle")
               "Otl" '(org-babel-load-file :which-key "Load file"))
    :config
    (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp")))
#+end_src
** In line latex previews
#+BEGIN_SRC emacs-lisp :tangle ~/.emacs.d/GNUEmacs.el
        (use-package org-fragtog
          :defer t
          :after org
          :hook
         (org-mode . org-fragtog-mode)
         :bind (:map org-mode-map
                     ("C-c tf" . org-fragtog-mode)))
#+END_SRC
